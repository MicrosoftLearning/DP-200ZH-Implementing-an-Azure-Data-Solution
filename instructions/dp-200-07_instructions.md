---
lab:
    title: '使用 Azure 数据工厂安排数据移动'
    module: '模块 7:利用 Azure 数据工厂编排数据移动'
---

# DP 200 - 实施数据平台解决方案
# 实验室 7 - 使用 Azure 数据工厂安排数据移动

**预计用时**：45 分钟

**先决条件**：假设已阅读了本实验室的案例研究。假设模块 1：数据工程师 Azure 的内容和实验适用于数据工程师的 Azure 也已完成

**实验室文件**：本实验室的文件位于_Allfiles\Labfiles\Starter\DP-200.7_文件夹。

## 实验室概述

在本模块中，学生将学习如何使用 Azure 数据工厂来安排来自各种数据平台技术的数据移动。他们将能够解释此技术的功能，并能够设置端到端数据管道，从 SQL 数据库中引入数据并将数据加载到 SQL 数据仓库中。学生还将演示如何调用计算资源。

## 实验室目标
  
在完成本实验后，你将能够：

1. 解释数据流和事件处理
1. 事件中心的数据引入
1. 使用流分析作业处理数据

## 方案
  
在将数据仓库的初始填充执行到 Azure SQL 数据仓库之后，信息服务部门想要自动执行此过程。您被要求支持信息服务部门开发可以自动从 Azure SQL 数据库移动数据的解决方案。

你的解决方案应该能够执行  [SalesLT].[ProductCategory] 和 [SalesLT].[ProductDescription] 事务表的完整副本，此事务表充当 Azure SQL 数据仓库中同名的维度表。此外，该解决方案还应遵循使用 Azure 数据工厂作为数据移动的业务流程协调程序加载到大规模并行处理 (MPP) 系统的最佳做法。

此外，数据科学家要求确认是否可以从 Azure 数据工厂调用 Azure Databricks。为此，你将创建一个简单的概念验证数据工厂管道，该管道将 Azure Databricks 调用为计算资源。

在本实验结束时，你将能够：

1. 说明 Azure 数据工厂的工作原理
1. Azure 数据工厂组件
1. Azure 数据工厂和 Databricks

> **重要事项**：在完成本实验时，请记下你在任何设置或配置任务中遇到的任何问题，并将其记录在位于_\Labfiles\DP-200-Issues-Doc.docx_的文档的表格中。记录实验室编号，记录技术，说明问题以及解决方案的内容。保存该文档，以便在稍后的模块中参考它。

## 练习 1：说明 Azure 数据工厂的工作原理

预计用时：15 分钟

小组练习
  
本练习的主要任务如下：

1. 从案例研究和场景中，确定 AdventureWorks 的数据流引入技术，以及你作为数据工程师要完成社交媒体分析要求所应执行的高级任务。

1. 教师将与小组讨论结果。

### 任务 1：确定 AdventureWorks 的数据要求和结构。

1. 从实验室拟机中，启动 **Microsoft Word**，然后从 **Allfiles\Labfiles\Starter\DP-200.6** 文件夹中打开文件 **DP-200-Lab06-Ex01.docx**。

1. 作为小组，花 **10分钟** 讨论并列出你的小组在案例研究文档中确定的数据要求和数据结构。

### 任务 2：与教师讨论结果

1. 教师将使小组停下来讨论结果。

> **结果**：完成本练习后，你已创建一个 Microsoft Word 文档，其中显示了数据流引入表以及你作为数据工程师要完成社交媒体分析要求所应执行的高级任务。

## 练习 2：Azure 数据工厂组件
  
预计用时：15 分钟

个人练习
  
本练习的主要任务如下：

1. 创建数据工厂实例。

1. 创建输入链接服务

1. 定义输入数据集

1. 创建输出链接服务

1. 定义输出数据集

1. 完成 SQL 数据仓库的优化设置

1. 监控管道执行

1. 确认 Azure 数据工厂组件

1. 验证数据输出

### 任务 1：创建数据工厂实例

1. 在 Microsoft Edge 中，转到 Azure 门户选项卡，选择 **+ 创建资源**，键入 **工厂**，然后从结果搜索中选择 **数据工厂**。然后选择 **创建**。

1. 使用以下选项创建新的数据工厂，然后单击 **创建**：
    - **名称**：xx-data-factory，其中 xx 是你的首字母缩写
    - **订阅**：你的订阅
    - **资源组**：awrgstudxx
    - **版本**：V2
    - **位置**：选择离你最近的位置
    - 将其他选项保留为默认设置

    > **注**：创建数据工厂大约需要 1 分钟。

### 任务 2：创建输入链接服务

1. 在 Azure 门户中，将返回一条消息，指出 Azure 数据工厂安装已成功完成，单击 **转到资源**。

1. 在 **xx - 数据 - 工厂** 屏幕中，单击 **作者与监控**。打开另一个选项卡以创建 Azure 数据工厂解决方案。
 
1. 在 **开始** 页面，选择 **复制数据** 图块以启动“复制数据”工具：

1. 在 **属性** 页面，为“任务”名称字段指定 **CopyFromSQLToSQLDW**，然后选择“下一步”：

1. 在 **源数据存储** 页面，完成以下步骤，然后单击 **下一步**：
    - 单击 **+ 创建新连接**：
    - 从库中选择 **Azure SQL 数据库**，然后选择 **继续**。
    - 在 **新建链接服务（Azure SQL 数据库）** 页面中，从下拉列表中选择你的服务器名称 **sqlservicexx** 和名为 **DeptDatabasesxx** 的数据库，并指定用户名和密码。单击 **测试连接** 连接以验证设置，然后单击 **完成**。

### 任务 3：定义输入数据集

1. 在“复制数据向导”的“选择要从中复制数据或使用自定义查询的表。”的 **现有表** 下，单击 [SalesLT].[ProductCategory] 和 [SalesLT].[ProductDescription] 旁的复选框，然后单击 **下一步**。

### 任务 4：创建输出链接服务

1. 在 **目标数据存储** 页面，完成以下步骤，然后单击 **下一步**：
    - 单击 **+ 创建新连接**：
    - 从库中选择 **Azure SQL 数据仓库**，然后选择 **继续**。
    - 在 **新建链接服务（Azure SQL 数据仓库）** 页面中，从下拉列表中选择你的服务器名称 **sqlservicexx** 和名为 **DWDB** 的数据库，并指定用户名和密码。单击 **测试连接** 连接以验证设置，然后单击 **完成**。

### 任务 5：定义输出数据集

1. 在“复制数据向导”中“表映射”的 **资源**下，确保 [SalesLT].[ProductCategory] 和 [SalesLT].[ProductDescription] 旁边的复选框，并且目标名相同。单击 **下一步**。
 
1. 在“复制数据向导”的“列映射”中，通读 **列映射**，该列映射应该是源和目标之间列的直接副本。单击 **下一步**。

### 任务 6：完成 SQL 数据仓库的优化设置

1. 在“复制数据向导”中“设置”的 **性能设置** 下，确保已选择 **启用暂存** 旁边的复选框。

1. 在“暂存帐户链接服务”旁，单击 **+ 新建**，在“新建链接服务”页面中，选择你的存储帐户 **awsastudxx**，并选择 **完成**。

1. 在 **高级设置** 部分中，确保已选择 **允许 PolyBase**。 

1. 在 **高级设置** 部分中，取消选择 **使用默认类型** 选项，单击 **下一步**。

1. 在 **摘要** 页面中，查看设置，然后选择 **下一步** 

### 任务 7：监控管道执行

1. 在“部署”页面中，选择“监控”以 **监控** 管道任务。

1. 请注意，将自动选择左侧的“监控”选项卡。**操作** 列包含 **查看活动** 运行详细信息并重新运行管道的链接。

1. 要查看与管道运行关联的活动运行，请选择“操作”列中的 **查看活动运行** 链接。要切换回管道运行视图，请选择顶部的 **管道** 链接。选择 **刷新** 刷新列表。

1. 要监控每个复制活动的执行详细信息，请选择活动监控视图中“操作”下的 **详细信息** 链接。你可以监控从源复制到接收器的数据量、数据吞吐量、具有相应持续时间的执行步骤以及使用的配置等详细信息：

### 任务 8：确认 Azure 数据工厂组件

1. 在 **作者与监控** 屏幕中，单击 **作者** 图标。

1. 在 **工厂资源** 中确认有 **一个管道** 和 **两个数据集**，如你刚刚执行的“复制向导”中定义的那样。

1. 关闭 Microsoft Edge 中的 Azure 数据工厂选项卡

### 任务 9：验证数据输出

1. 在 Windows 桌面上，单击 **开始**，并键入 **"SQL Server"**，然后单击 **Microsoft SQL Server Management Studio 17**

1. 在 **连接到服务器** 对话框中，填写以下详细信息
    - 服务器名：**sqlservicexx.database.windows.net**
    - 身份验证：**SQL Server 身份验证**
    - 用户名：**xxsqladmin**
    - 密码：**P@ssw0rd**

1. 在 **连接到服务器** 对话框中，单击 **连接**。

1. 展开数据库 **DWDB**，然后展开 **表**，并确认 [SalesLT].[ProductCategory] 和 [SalesLT].[ProductDescription] 存在。

1. 关闭 **Microsoft SQL Server Management Studio**

> **结果**：完成本练习后，你已创建 Azure 数据工厂组件，以通过使用向导将数据从 Azure SQL 数据库移动到 Azure SQL 数据仓库。你已确认使用的组件以及数据已加载到数据仓库中。

## 练习 3：Azure 数据工厂和 Databricks
  
预计用时：15 分钟

个人练习
  
本练习的主要任务如下：

1. 生成 Databricks 访问令牌。

1. 生成 Databricks 笔记本

1. 创建链接服务

1. 创建使用 Databricks 笔记本活动的管道。

1. 触发管道运行。

### 任务 1：生成 Databricks 访问令牌。

1. 在 Azure 门户中，单击 **资源组**，然后单击 **awrgstudxx**，再单击 **awdbwsstudxx**，其中 xx 是你的首字母缩写。

1. 单击 **启动工作区**

1. 单击 Databricks 工作区右上角的用户 **个人资料图标**。

1. 单击 **用户设置**。

1. 转到“访问令牌”选项卡，然后单击 **生成新令牌** 按钮。

1. 在 **注释** "For ADF Integration" 中输入描述，然后将 **生命周期** 设置为 10 天并单击 **生成**

1. 复制生成的令牌并存储在记事本中，然后单击 **完成**。

### 任务 2：生成 Databricks 笔记本

1. 在屏幕左侧，单击 **工作区** 图标，然后单击词语“工作区”旁的箭头，再单击 **创建**，然后单击 **文件夹**。命名文件夹 **adftutorial**，然后单击 **创建文件夹**。adftutorial 文件夹会显示在“工作区”中。

1. 单击 adftutorial 旁的下拉箭头，然后单击 **创建**，再单击 **笔记本**。

1. 在“创建笔记本”对话框中，键入 **mynotebook** 的名称，并确保语言陈述为 **Python**，然后单击 **创建**。出现 mynotebook 标题的笔记本/

1. 在新创建的笔记本 "mynotebook" 中添加以下代码：

    ```Python
    # Creating widgets for leveraging parameters, and printing the parameters

    dbutils.widgets.text("input", "","")
    dbutils.widgets.get("input")
    y = getArgument("input")
    print ("Param -\'input':")
    print (y)
    ```

    > **注意** 笔记本路径是 **/adftutorial/mynotebook**

### 任务 3：创建链接服务

1. 在 Microsoft Edge 中，单击 Azure 门户中门户的选项卡，然后返回到 Azure 数据工厂。

1. 在 **xx - 数据 - 工厂** 屏幕中，单击 **作者与监控**。打开另一个选项卡以创建 Azure 数据工厂解决方案。

1. 在屏幕左侧，单击 **作者** 图标。这会打开“数据工厂”设计器。

1. 在屏幕底部，单击 **连接**，然后单击 **+ 新建**。

1. 在 **新链接服务** 中的屏幕顶部，单击 **计算**，然后单击 **Azure Databricks**，再单击 **继续**。

1. 在**新链接服务 (Azure Databricks)** 屏幕中，填写以下详细信息并单击 **完成**
    - **名称**：xx_dbls，其中 xx 是你的首字母缩写
    - **Databricks 工作区**：awdbwsstudxx，其中 xx 是你的首字母缩写
    - **选择群集**：使用现有
    - **域/区域**：应该填充
    - **访问令牌**：从记事本中复制访问令牌并粘贴到此字段中
    - **从现有群集中选择**：awdbclstudxx，其中 xx 是你的首字母缩写
    - 将其他选项保留为默认设置

    > **注**：单击完成后，你将返回到 **作者与监控** 屏幕，其中已创建 xx_dbls，其他链接服务在之前练习中创建。

### 任务 5：创建使用 Databricks 笔记本活动的管道。

1. 在屏幕左侧的“工厂资源”下，单击 **+** 图标，然后单击 **管道**。这将打开带有“管道”设计器的选项卡。

1. 在管道设计器的底部，单击参数选项卡，然后单击 **+ 新建**

1. 创建名为 **名称**，类型为 **字符串** 的参数

1. 在 **活动** 菜单下，展开 **Databricks**。

1. 单击并将 **笔记本** 拖动到画布上。

1. 在底部 **Notebook1** 窗口的属性中，完成以下步骤：
    - 切换到 **Azure Databricks** 选项卡。
    - 选择你在上一过程中创建的 **xx_dbls**。

    - 切换到 **设置** 选项卡，并把 **/adftutorial/mynotebook** 放到笔记本路径中。
    - 展开 **基本参数**，然后单击 **+ 新建**
    - 创建名为 **输入**，值为 **@pipeline().parameters.name** 的参数

1. 在 **Notebook1** 中，单击“另存为模板”按钮旁的 **验证**。屏幕右侧会显示窗口，表示“你的管道已验证。
未发现任何错误。”单击 >> 关闭此窗口。

1. 单击 **全部发布** 发布链接的服务和管道。

    > **注**：将显示一条消息，表示部署成功。

### 任务 6：触发管道运行

1. 在 **Notebook1** 中，单击 **添加触发器**，然后单击“调试”按钮旁的 **立即触发**。

1. **管道运行** 对话框要求输入名称参数。这里使用 **/path/filename** 作为参数。单击“完成”。画布中的 Notebook1 活动上方出现一个红色圆圈。

### 任务 7：监控管道

1. 在屏幕左侧，单击 **监控** 选项卡。确认你看到管道运行。创建一个执行笔记本的Databricks作业集群大约需要5-8分钟。

1. 定期选择 **刷新** 检查管道运行的状态。

1. 要查看与管道运行关联的活动运行，请选择 **操作** 列中的 **查看活动运行**。

### 任务 8：验证输出

1. 在 Microsoft Edge 中，单击选项卡 **mynotebook - Databricks** 

1. 在 **Azure Databricks** 工作区中，单击 **群集**，然后你可以看到作业状态为待执行、正在运行或已终止。

1. 单击群集 **awdbclstudxx**，然后单击 **事件日志** 查看活动。

    > **注**：触发管道运行时，你应该看到事件类型 **开始**。