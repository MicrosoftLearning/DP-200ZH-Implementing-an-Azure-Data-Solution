---
lab:
    title: '使用流分析执行实时分析'
    module: '模块 6:使用流分析执行实时分析'
---

# DP 200 - 实施数据平台解决方案
# 实验室 6 - 使用流分析执行实时分析

**预计用时**：60 分钟

**先决条件**：假设已阅读了本实验室的案例研究。假设模块1的内容和实验：适用于数据工程师的 Azure 也已完成

**实验室文件**：本实验室的文件位于_Allfiles\Labfiles\Starter\DP-200.6_文件夹。

## 实验室概述

学生将能说明数据流是什么，以及事件处理如何运行，并为AdventureWorks案例研究选择合适的数据流引入技术。他们将配置所选的引入技术，并将其与流分析集成，以创建适用于流数据的解决方案。

## 实验室目标
  
在完成本实验后，你将能够：

1. 解释数据流和事件处理
1. 事件中心的数据引入
1. 使用流分析作业处理数据

## 方案
  
作为数字转换项目的一部分，CIO的任务是帮助营销部门提高工作效率。在过去的几年里，营销部门一直在使用Twitter来宣传关于其销售的自行车产品的营销信息。 

虽然该部门可以了解活动后的参与人数，但他们无法了解谁正在实时与其活动进行互动，因为这些数据很难手动跟踪。因此，他们希望应用能够实时跟踪谁对其活动做出响应的系统。

在本实验结束时，你将能够：

1. 解释数据流和事件处理
1. 事件中心的数据引入
1. 使用流分析作业处理数据

> **重要事项**：在完成本实验时，请记下你在任何设置或配置任务中遇到的任何问题，并将其记录在位于_\Labfiles\DP-200-Issues-Doc.docx_的文档的表格中。记录实验室编号，记录技术，说明问题以及解决方案的内容。保存该文档，以便在稍后的模块中参考它。

## 练习 1：解释数据流和事件处理

预计用时：15 分钟

小组练习
  
本练习的主要任务如下：

1. 从案例研究和场景中，确定 AdventureWorks 的数据流引入技术，以及你作为数据工程师要完成社交媒体分析要求所应执行的高级任务。

1. 教师将与小组讨论结果。

### 任务 1：确定 AdventureWorks 的数据要求和结构。

1. 从实验室虚拟机中，启动 **Microsoft Word**，然后从 **Allfiles\Labfiles\Starter\DP-200.6** 文件夹中打开文件 **DP-200-Lab06-Ex01.docx**。

1. 作为小组，花 **10分钟** 讨论并列出你的小组在案例研究文档中确定的数据要求和数据结构。

### 任务 2：与教师讨论结果

1. 教师将使小组停下来讨论结果。

> **结果**：完成本练习后，你已创建一个 Microsoft Word 文档，其中显示了数据流引入表以及你作为数据工程师要完成社交媒体分析要求所应执行的高级任务。

## 练习 2：通过事件中心引入数据。
  
预计用时：15 分钟

个人练习
  
本练习的主要任务如下：

1. 创建和配置事件中心命名空间。

1. 创建和配置事件中心。

1. 配置事件中心安全性。

### 任务 1：创建和配置事件中心命名空间。

1. 在Azure门户中，选择 **创建资源**，输入 **事件中心**，然后从得出的搜索中选择 **事件中心命名空间**。然后选择 **创建**。

1. 使用以下选项创建事件中心命名空间，然后单击 **创建**：
    - **名称**：xx-socialtwitter-eh，其中xx是你的姓名缩写
    - **定价层**：标准
    - **订阅**：你的订阅
    - **资源组**：awrgstudxx
    - **位置**：选择离你最近的位置
    - 将其他选项保留为默认设置

    > **注**：事件中心命名空间的创建大约需要1分钟。

### 任务 2：创建和配置事件中心

1. 在Azure门户的边栏选项卡中，单击 **资源组**，然后单击 **awrgstudxx**，再单击 **awdlsstudxx**，其中 **xx** 是你的姓名缩写

1. 单击 **XX-socialtwitter-EH**，其中 **XX** 是你的姓名缩写。

1. 在 **XX-socialtwitter-EH** 屏幕中，单击 **活动中心**。

1. 提供名称 **socialtwitter-EH**，然后选择 **创建**。

    > **注**：你将收到一条消息，说明在大约10秒后创建了事件中心

### 任务 3：配置事件中心安全性

1. 在Azure门户中，在 **XX-socialtwitter-EH** 中，**XX** 是你的姓名缩写。滚动到窗口底部，然后单击 **socialtwitter-EH** 活动中心。

1. 为了授予对事件中心的访问权限，请单击 **共享访问策略**。

1. 在 **socialtwitter-eh - 共享访问策略** 屏幕下，创建通过选择 **添加** 来进行的 **管理** 许可政策。将策略命名为 **socialtwitter-EH-SAP**，检查 **管理**，然后单击 **创建**。

1. 在创建后，单击你的新政策 **socialtwitter-EH-SAP**，然后选择复制按钮 **连接字符串 - 主密钥** 并将连接字符串 - 主密钥粘贴到记事本中，稍后在练习中需要这样做。

1. 关闭门户中的事件中心屏幕

> **结果**：完成本练习后，你已在Event Hub命名空间中创建Azure事件中心，并设置事件中心的安全性，此事件中心可用于提供对服务的访问。

## 练习 3：使用流分析作业处理数据

预计用时：30 分钟

个人练习

本练习的主要任务如下：

1. 创建一个Twitter开发者帐户

1. 配置Twitter访问密钥

1. 配置并启动Twitter客户端应用程序

1. 预配流分析作业。

1. 指定流分析作业输入。

1. 定义流分析查询。

1. 指定流分析作业输出。

1. 修改流分析查询。

1. 启动流分析作业。

1. 收集确认流数据

### 任务 1：创建一个Twitter开发者帐户。

1. 在浏览器中打开一个新选项卡，然后转到https://developer.twitter.com/en/apps/并使用你的Twitter帐户登录以设置Twitter应用程序。

1. 在 **应用** 页面中的右侧，单击按钮 **创建应用程序**。

1. 在“请申请推特帐号”中，单击 **应用**。

1. 在“用户个人资料”页面中，确认你的Twitter帐户是与开发者帐户关联的正确帐户，然后单击 **继续**。

1. 在“帐户详细信息”页面的“你以什么身份请求访问？”下，单击 **我请求访问，用于个人使用**。在“帐户名称”下，输入 **学习如何编码为 *twitter_name***。最后，选择 **主要经营国** 作为你居住的国家。单击 **继续**。

    > **注**：请记住遵守你所在国家/地区的所有适用法律和道德规范

1. 在“告诉我们你的项目”页面中，选择“你感兴趣的用例是什么？”选项。按照本课程的目的选择 **学生项目/学习编码**。在“用你自己的话描述你正在构建的内容”中，用300个单词来解释为什么要使用它。下面是一个示例：

    >1.我正在使用Twitter的API来学习如何在学习应用程序中嵌入twitter语句。此帐户用于了解如何执行此操作
    >2.  我计划分析推文，以了解如何实时计算和阅读流推文，作为学习练习的一部分
    >3.我不打算以转发或喜欢内容的形式与其他人的推文进行互动。我将阅读和计算推文并观察情绪。
    >4.将在应用程序中分析个人和聚集推文 

1. 最后，选择“你的产品、服务或分析是否会将Twitter内容或派生信息提供给政府实体”这一问题的选项？然后单击 **继续**。

1. 如果你同意，点击 **接受** 来阅读并同意服务条款。然后根据需要选择复选框。单击 **递交申请** 

1. 检查收件箱中的验证邮件，在电子邮件中单击 **确认你的电子邮件** 来完成该过程。你将返回twitter欢迎屏幕。

### 任务 2：配置Twitter访问密钥

1. 如果你不在Twitter欢迎屏幕上，请在浏览器中打开一个新选项卡，然后转到https://developer.twitter.com并使用你的Twitter帐户登录。

1. 在“欢迎”或“应用程序”页面中，单击按钮 **创建应用程序**。

1. 在“创建应用程序”页面中，提供以下信息并单击 **创建**：
    - **名称**：xx-social-app，其中xx是你的姓名缩写
    - **应用程序说明**：添加类似于“用于收集和聚集推文”的说明
    - **网站URL** 你可以用于申请的个人地址。
    - **告诉我们将如何使用该应用程序**：编写文本概述：该应用程序是一个演示应用程序，用于了解如何使用流数据

1. 查看开发者条款并单击 **创建**。将出现一个新页面，其中包含你的应用程序名称。

1. 单击名为 **密钥和令牌** 的页面选项卡

1. 在“访问令牌并访问令牌密钥”下，单击 **创建** 按钮。

    >**注**：将为你的帐户和当前应用程序生成授权访问令牌和密钥。

1. 将以下密钥复制到之前打开的记事本文件：
    - 消费者密钥（API密钥）
    - 消费者密钥（API密钥）
    - 访问令牌
    - 访问令牌密钥

### 任务 3：配置并启动Twitter客户端应用程序

1. 双击 **Allfiles\Labfiles\Starter\DP-200.6\Twitter client\TwitterWPFClient\TwitterWPFClient** 位置的 **TwitterWPFClient.exe**。你也可以在[TwitterWPFClient here](https://github.com/Azure/azure-stream-analytics/tree/master/Samples/TwitterClient)下载。

1. 将记事本的数据输入到TwitterWPFClient.exe应用程序中。
    - **Twitter消费者密钥（API密钥）**：你的Twitter消费者密钥
    - **Twitter消费者密钥（API密钥）**：你的Twitter消费者密钥
    - **Twitter访问令牌**：你的Twitter访问令牌
    - **Twitter访问密钥**：你的Twitter访问密钥
    - **Azure事件中心名称**：socialtwitter-eh。
    - **Azure事件中心连接字符串**：终点=sb://xx-socialtwitter-eh.servicebus.windows.net/;SharedAccessKeyName=xx-social-eh-sap;SharedAccessKey=<Paste in the CONNECTION STRING - PRIMARY KEY from Notepad>  

        >**重要事项**：重要的是在字符串结束时删除;EntityPath=socialtwitter-eh。

    - **搜索组** 定义你想要确定哪些关键字的情绪。一个示例可能是“#Brexit”或brexit，或者你可以添加由逗号分隔的多个关键字。

1. 在 **TwitterWPFClient.exe** 应用程序中单击 **播放** 按钮，等待直到你看到控制台中出现的推文并保持应用程序继续运行。

      > **注**：该 **TwitterWPFClient.exe** 应用程序捕获日期、搜索术语情绪分数、推特名称和定义的搜索词的推文详细信息。 

1. 让所有应用程序保持运行

### 任务 4：预配流分析作业。

1. 返回Azure门户，选择 **创建资源**，输入 **流**，然后单击 **流分析工作**，然后单击 **创建**。
1. 
1. 在 **新流分析工作** 屏幕中，填写以下详细信息，然后单击 **创建**：
    - **工作名称**：socialtwitter-asa-job。
    - **订阅**：选择你的订阅
    - **资源组**：awrgstudxx
    - **位置**：选择离你最近的位置。
    - 将其他选项保留为默认设置

    > **注**：你将收到一条消息，指出在大约10秒后创建了流分析作业

### 任务 5：指定流分析作业输入。

1. 在Azure门户的边栏选项卡中，单击 **资源组**，然后单击 **awrgstudxx**，再单击 **awdlsstudxx**，其中 **xx** 是你的姓名缩写

1. 单击 **socialtwitter-asa-job**。

1. 在你的 **socialtwitter-asa-job** 流分析作业窗口，单击 **输入**。

1. 在 **输入** 屏幕中，单击 **添加流输入**，然后单击 **活动中心**。

1. 在活动中心屏幕中，输入以下值并单击 **保存** 按钮。
    - **输入别名**：输入此作业输入的名称作为TwitterStream。
    - **从你的订阅中选择事件中心**：检查
    - **订阅**：你的订阅名称
    - **事件中心命名空间**：xx-socialtwitter-eh
    - **事件中心名称**：使用现有的名称socialtwitter-eh
    - **事件中心策略名称**：socialtwitter-eh-sap
    - 将剩余选项保留为默认值

1. 完成后，TwitterStream输入作业将出现在输入窗口下。关闭输入窗口以返回流分析作业页面

### 任务 6：定义流分析查询。

1. 在你的 **socialtwitter-asa-job** 窗口，在屏幕中间的 **查询** 窗口，单击 **编辑查询**

1. 在代码编辑器中替换以下查询：

    ```SQL
    SELECT
        *
    INTO
        [YourOutputAlias]
    FROM
        [YourInputAlias]
    ```

1. 替换为

    ```SQL
    SELECT 
     [Topic]
    [SentimentScore]
    [created_at]
    ,[Author]
    ,[text]
    FROM [TwitterStream]
    ```

1. 选择“保存”。

1. 关闭“查询”窗口以返回“流分析”作业页面。


### 任务 7：指定流分析作业输出。

1. 在你的 **socialtwitter-asa-job** 流分析作业窗口，单击 **输出**。

1. 在 **输出** 屏幕中，单击 **添加**，然后单击 **Blob存储**。

1. 在 **Blob存储** 窗口中，在窗格中输入或选择以下值：
- **输出别名**：输出
- **从你的订阅中选择事件中心**：检查
- **订阅**：你的订阅名称
- **存储帐户**：awsastudxx，其中xx是你的姓名缩写
- **容器**：使用现有的和选择的推文

1. 将其余条目保留为默认值。最后，单击 **保存***。

1. 关闭输出屏幕以返回流分析作业页面

### 任务 8：定义流分析查询。

1. 在你的 **socialtwitter-asa-job** 窗口，在屏幕中间的 **查询** 窗口，单击 **编辑查询**

1. 在代码编辑器中替换以下查询：

    ```SQL
    SELECT 
     [Topic]
    [SentimentScore]
    [created_at]
    ,[Author]
    ,[text]
    FROM [TwitterStream]
    ```

1. 替换为

    ```SQL
    SELECT 
     [Topic]
    [SentimentScore]
    [created_at]
    ,[Author]
    ,[text]
    INTO [Outputs]
    FROM [TwitterStream]
    ```

1. 选择“保存”。

1. 关闭“查询”窗口以返回“流分析”作业页面。

### 任务 9：启动流分析作业

1. 在你的 **socialtwitter-asa-job** 窗口，在屏幕中间的 **查询** 窗口，单击 **启动**
 
1. 在打开的 **启动工作** 对话框，单击 **现在**，然后单击 **启动**。 

>**注**：在你的 **socialtwitter-asa-job** 窗口，作业开始一分钟后会显示一条消息，并且启动的字段将更改为启动的时间

>**注**：运行2分钟，以便捕获数据。

### 任务 10：收集确认流数据

1. 在Azure门户的边栏选项卡中，单击 **资源组**，然后单击 **awrgstudxx**，再单击 **awsastudxx**，其中 **xx** 是你的姓名缩写

1. 在Azure门户中，单击 **Blobs** 屏幕。

1. 在Azure门户中，在 **awsastudxx  -  Blobs** 屏幕中，单击 **推文** 列表中的项目。

1. 确认出现JSON文件，并记下大小列。

1. 刷新Microsoft Edge，并且屏幕刷新时不刷新文件的大小

    >**注**：你可以下载文件以查询JSON数据，也可以将数据输出到Power BI。

> **结果**：完成本练习后，你已配置Azure流分析以将流数据收集到Azure Blob中的JSON文件存储中。你已经通过流媒体twitter数据完成了这项工作

## 关闭

1. 在Azure门户的边栏选项卡中，单击 **资源组**，然后单击 **awrgstudxx**，再单击 **socialtwitter-asa-job**。

1. 在 **socialtwitter-asa-job** 屏幕中，单击 **停止**。在 **停止流工作** 对话框中，单击 **是**。

1. 关闭 **TwitterWPFClient.exe** 应用程序。